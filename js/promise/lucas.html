<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script>
        function Promise(executor) {
            this.status = 'pending'
            this.value = null
            this.reason = null
            this.onFulfilledArray = []
            this.onRejectedArray = []

            const resolve = value => {
                if (value instanceof Promise) {
                    return value.then(resolve, reject)
                }
                setTimeout(() => {
                    if (this.status === 'pending') {
                        this.value = value
                        this.status = 'fulfilled'

                        this.onFulfilledArray.forEach(func => {
                            func(value)
                        })
                    }
                })
            }

            const reject = reason => {
                setTimeout(() => {
                    if (this.status === 'pending') {
                        this.reason = reason
                        this.status = 'rejected'

                        this.onRejectedArray.forEach(func => {
                            func(reason)
                        })
                    }
                })
            }


            try {
                executor(resolve, reject)
            } catch(e) {
                reject(e)
            }
        }

        Promise.prototype.then = function(onfulfilled, onrejected) {
            onfulfilled = typeof onfulfilled === 'function' ? onfulfilled : data => data
            onrejected = typeof onrejected === 'function' ? onrejected : error => { throw error}

            if (this.status === 'fulfilled') {
                onfulfilled(this.value)
            }
            if (this.status === 'rejected') {
                onrejected(this.reason)
            }
            if (this.status === 'pending') {
                this.onFulfilledArray.push(onfulfilled)
                this.onRejectedArray.push(onrejected)
            }
        }


        // --------
        const MyPromise = Promise
        const p1 = new MyPromise((resolve, reject) => {
            resolve(new MyPromise((resolve2, reject2) => {
                setTimeout(() => {
                    resolve2(new MyPromise((resolve3, reject3) => {
                        setTimeout(() => {
                            reject3('你输了')
                        }, 400)
                    }))
                }, 500)
            }))
            resolve(new MyPromise((resolve, reject2) => {
                setTimeout(() => {
                    reject2('马后炮')
                }, 1000)
            }))
        })
        p1.then((v) => {
            console.log(v)
        }, (v) => {
            console.error(v)
        })
    </script>
</head>
<body>

</body>
</html>